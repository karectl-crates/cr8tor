# VDI pod templates
apiVersion: v1
kind: ConfigMap
metadata:
  name: vdi-pod-template
  namespace: cr8tor
data:
  vdi-pod-template.yaml.j2: |
    apiVersion: v1
    kind: Pod
    metadata:
      name: vdi-{{ name }}
      namespace: {{ namespace }}
      labels:
        app: vdi
        user: "{{ user }}"
        project: "{{ project }}"
    spec:
      containers:
        - name: desktop
          image: "{{ image }}"
          imagePullPolicy: Always
          env:
            {% if password %}
            - name: NEW_PASSWORD
              value: "{{ password }}"
            {% endif %}
            - name: VDI_USER
              value: "{{ user }}"
            - name: VDI_PROJECT
              value: "{{ project }}"
            - name: KARECTL_USER
              value: "{{ user }}"
            - name: KARECTL_PROJECT
              value: "{{ project }}"
            - name: VDI_LINUX_USER
              value: "{{ linux_user }}"
            - name: KARECTL_ENVIRONMENT
              value: "{{ env_vars | selectattr('name', 'equalto', 'KARECTL_ENVIRONMENT') | map(attribute='value') | first | default('stg', true) }}"
            - name: KARECTL_DOMAIN
              value: "{{ env_vars | selectattr('name', 'equalto', 'KARECTL_DOMAIN') | map(attribute='value') | first | default('karectl.org', true) }}"
            {% if env_vars %}
            {% for env_var in env_vars %}
            - name: {{ env_var.name }}
              value: "{{ env_var.value }}"
            {% endfor %}
            {% endif %}
          ports:
            - containerPort: 3389
            - containerPort: 5900
          readinessProbe:
            tcpSocket:
              port: 3389
            initialDelaySeconds: 5
            periodSeconds: 2
            timeoutSeconds: 1
            successThreshold: 1
            failureThreshold: 3
          volumeMounts:
            - name: home
              mountPath: /home/ubuntu
            - name: init-scripts
              mountPath: /scripts
          lifecycle:
            postStart:
              exec:
                command:
                  - /bin/bash
                  - /scripts/init-desktop.sh
      volumes:
        - name: home
          emptyDir: {}
        - name: init-scripts
          configMap:
            name: vdi-init-scripts
            defaultMode: 0755
      terminationGracePeriodSeconds: 10
    ---
    apiVersion: v1
    kind: Service
    metadata:
      name: vdi-{{ user }}-{{ project }}
      namespace: {{ namespace }}
      labels:
        app: vdi
        user: "{{ user }}"
        project: "{{ project }}"
    spec:
      selector:
        app: vdi
        user: "{{ user }}"
        project: "{{ project }}"
      ports:
        - name: rdp
          port: 3389
          targetPort: 3389
        - name: vnc
          port: 5900
          targetPort: 5900
      type: ClusterIP
  windows-vdi-pod-template.yaml.j2: |
    apiVersion: v1
    kind: Pod
    metadata:
      name: vdi-{{ name }}
      namespace: {{ namespace }}
      labels:
        app: vdi
        user: "{{ user }}"
        project: "{{ project }}"
        os-type: windows-vm
    spec:
      containers:
      - name: desktop
        image: {{ image }}
        ports:
        - containerPort: 3389
          protocol: TCP
        - containerPort: 5900
          protocol: TCP
        - containerPort: 8006
          protocol: TCP
        env:
        - name: USERNAME
          value: "{{ user }}"
        - name: PASSWORD
          value: "{{ password }}"
        - name: RAM_SIZE
          value: "2G"
        - name: CPU_CORES
          value: "2"
        - name: DISK_SIZE
          value: "30G"
        {% for env_var in env_vars %}
        - name: {{ env_var.name }}
          value: "{{ env_var.value }}"
        {% endfor %}
        securityContext:
          privileged: true
        resources:
          requests:
            memory: "3Gi"
            cpu: "2"
          limits:
            memory: "6Gi"
            cpu: "4"
        volumeMounts:
        - name: dev-kvm
          mountPath: /dev/kvm
        - name: user-data
          mountPath: /storage
      volumes:
      - name: dev-kvm
        hostPath:
          path: /dev/kvm
      - name: user-data
        emptyDir: {}
      restartPolicy: Always
    ---
    apiVersion: v1
    kind: Service
    metadata:
      name: vdi-{{ user }}-{{ project }}
      namespace: {{ namespace }}
      labels:
        app: vdi
        user: "{{ user }}"
        project: "{{ project }}"
        os-type: windows
    spec:
      selector:
        app: vdi
        user: "{{ user }}"
        project: "{{ project }}"
      ports:
      - name: rdp
        port: 3389
        targetPort: 3389
        protocol: TCP
      - name: vnc
        port: 5900
        targetPort: 5900
        protocol: TCP
      - name: web
        port: 8006
        targetPort: 8006
        protocol: TCP
      type: ClusterIP
---
# VDI initialization scripts
apiVersion: v1
kind: ConfigMap
metadata:
  name: vdi-init-scripts
  namespace: cr8tor
data:
  init-desktop.sh: |
    #!/bin/bash
    # Script to create desktop shortcuts
    set -e
    echo "Starting VDI Desktop Setup"
    echo "User: ${KARECTL_USER}"
    echo "Project: ${KARECTL_PROJECT}"
    LINUX_USER="${VDI_LINUX_USER:-ubuntu}"
    echo "Using Linux user: ${LINUX_USER}"

    if [ -n "${KARECTL_ENVIRONMENT}" ] && [ -n "${KARECTL_DOMAIN}" ]; then
        ENVIRONMENT="${KARECTL_ENVIRONMENT}"
        DOMAIN="${KARECTL_DOMAIN}"
        echo "Using explicit environment and domain"
    elif [ -n "${KARECTL_BACKEND_URL}" ]; then
        # extract from backend URL
        if [[ "${KARECTL_BACKEND_URL}" == *".svc.cluster.local"* ]]; then
            # Internal cluster URL - use defaults
            ENVIRONMENT="${KARECTL_ENVIRONMENT:-dev}"
            DOMAIN="${KARECTL_DOMAIN:-cluster.local}"
            echo "Using internal cluster URL with defaults"
        else
            # External URL
            BACKEND_HOST=$(echo "${KARECTL_BACKEND_URL}" | sed 's|https\?://backend\.||' | sed 's|/.*||')
            ENVIRONMENT=$(echo "${BACKEND_HOST}" | cut -d. -f1)
            DOMAIN=$(echo "${BACKEND_HOST}" | cut -d. -f2-)
            echo "Extracted environment and domain from backend URL"
        fi
    else
        # no explicit values, using defaults
        ENVIRONMENT="${KARECTL_ENVIRONMENT:-dev}"
        DOMAIN="${KARECTL_DOMAIN:-localhost}"
        echo "Using default environment and domain"
    fi

    echo "Environment: ${ENVIRONMENT}"
    echo "Domain: ${DOMAIN}"
    DESKTOP_DIR="/home/${LINUX_USER}/Desktop"
    mkdir -p "${DESKTOP_DIR}"

    # Create .desktop file
    create_desktop_shortcut() {
        local name="$1"
        local url="$2"
        local icon="$3"
        local filename="$4"

        cat > "${DESKTOP_DIR}/${filename}" <<EOF
    [Desktop Entry]
    Version=1.0
    Type=Application
    Name=${name}
    Comment=Launch ${name} for ${KARECTL_PROJECT} project
    Exec=firefox --new-window "${url}"
    Icon=${icon}
    Terminal=false
    Categories=Application;Network;
    EOF

        chmod +x "${DESKTOP_DIR}/${filename}"
        echo "Created shortcut: ${name}"
    }

    # Create Firefox desktop shortcut
    cat > "${DESKTOP_DIR}/firefox.desktop" <<EOF
    [Desktop Entry]
    Version=1.0
    Type=Application
    Name=Firefox Browser
    Comment=Browse the Web
    Exec=firefox
    Icon=firefox
    Terminal=false
    Categories=Network;WebBrowser;
    EOF
    chmod +x "${DESKTOP_DIR}/firefox.desktop"

    if [ -n "${KARECTL_TOKEN}" ]; then
        SSO_URL="https://backend.${ENVIRONMENT}.${DOMAIN}/auth/sso?token=${KARECTL_TOKEN}&project=${KARECTL_PROJECT}&app=jupyter"

        create_desktop_shortcut \
            "JupyterHub - ${KARECTL_PROJECT^}" \
            "${SSO_URL}" \
            "applications-science" \
            "jupyterhub.desktop"
    fi

    # Configure MATE desktop settings
    mkdir -p /home/${LINUX_USER}/.config/dconf

    # Reset MATE panel to defaults
    dconf reset -f /org/mate/panel/ 2>/dev/null || true
    cat > /home/${LINUX_USER}/.config/dconf/user.conf <<EOF
    [org/mate/screensaver]
    idle-activation-enabled=false
    lock-enabled=false

    [org/mate/power-manager]
    sleep-display-ac=0
    sleep-display-battery=0
    button-lid-ac='nothing'
    button-lid-battery='nothing'
    EOF

    # Set Firefox preferences
    FIREFOX_PROFILE_DIR="/home/${LINUX_USER}/.mozilla/firefox"
    mkdir -p "${FIREFOX_PROFILE_DIR}"

    # Create user.js with preferences
    cat > "/home/${LINUX_USER}/user-prefs.js" <<EOF
    // Auto-generated Firefox preferences for VDI
    user_pref("browser.startup.homepage", "about:blank");
    user_pref("browser.startup.page", 0);
    user_pref("browser.shell.checkDefaultBrowser", false);
    user_pref("datareporting.healthreport.uploadEnabled", false);
    user_pref("datareporting.policy.dataSubmissionEnabled", false);
    user_pref("toolkit.telemetry.enabled", false);
    user_pref("browser.tabs.warnOnClose", false);
    user_pref("browser.sessionstore.resume_from_crash", false);
    EOF

    # Set ownership
    chown -R ${LINUX_USER}:${LINUX_USER} /home/${LINUX_USER}/Desktop || true
    chown -R ${LINUX_USER}:${LINUX_USER} /home/${LINUX_USER}/.mozilla 2>/dev/null || true
    chown -R ${LINUX_USER}:${LINUX_USER} /home/${LINUX_USER}/.config 2>/dev/null || true

    echo "====== Setup Complete ======"
    echo ""
    echo "Available shortcuts:"
    ls -lh "${DESKTOP_DIR}"/*.desktop 2>/dev/null || echo "No .desktop files found"
    echo ""
