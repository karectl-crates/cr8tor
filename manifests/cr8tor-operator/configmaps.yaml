# VDI pod templates
apiVersion: v1
kind: ConfigMap
metadata:
  name: vdi-pod-template
  namespace: cr8tor-system
data:
  vdi-pod-template.yaml.j2: |
    apiVersion: v1
    kind: Pod
    metadata:
      name: vdi-{{ name }}
      namespace: {{ namespace }}
      labels:
        app: vdi
        user: "{{ user }}"
        project: "{{ project }}"
    spec:
      containers:
        - name: desktop
          image: "{{ image }}"
          imagePullPolicy: Always
          env:
            {% if password %}
            - name: NEW_PASSWORD
              value: "{{ password }}"
            {% endif %}
            - name: VDI_USER
              value: "{{ user }}"
            - name: VDI_PROJECT
              value: "{{ project }}"
            {% if env_vars %}
            {% for env_var in env_vars %}
            - name: {{ env_var.name }}
              value: "{{ env_var.value }}"
            {% endfor %}
            {% endif %}
          ports:
            - containerPort: 3389
            - containerPort: 5900
          volumeMounts:
            - name: home
              mountPath: /home/ubuntu
      volumes:
        - name: home
          emptyDir: {}
      terminationGracePeriodSeconds: 10
    ---
    apiVersion: v1
    kind: Service
    metadata:
      name: vdi-{{ user }}-{{ project }}
      namespace: {{ namespace }}
      labels:
        app: vdi
        user: "{{ user }}"
        project: "{{ project }}"
    spec:
      selector:
        app: vdi
        user: "{{ user }}"
        project: "{{ project }}"
      ports:
        - name: rdp
          port: 3389
          targetPort: 3389
        - name: vnc
          port: 5900
          targetPort: 5900
      type: ClusterIP
  windows-vdi-pod-template.yaml.j2: |
    apiVersion: v1
    kind: Pod
    metadata:
      name: vdi-{{ name }}
      namespace: {{ namespace }}
      labels:
        app: vdi
        user: "{{ user }}"
        project: "{{ project }}"
        os-type: windows-vm
    spec:
      containers:
      - name: desktop
        image: {{ image }}
        ports:
        - containerPort: 3389
          protocol: TCP
        - containerPort: 5900
          protocol: TCP
        - containerPort: 8006
          protocol: TCP
        env:
        - name: USERNAME
          value: "{{ user }}"
        - name: PASSWORD
          value: "{{ password }}"
        - name: RAM_SIZE
          value: "2G"
        - name: CPU_CORES
          value: "2"
        - name: DISK_SIZE
          value: "30G"
        {% for env_var in env_vars %}
        - name: {{ env_var.name }}
          value: "{{ env_var.value }}"
        {% endfor %}
        securityContext:
          privileged: true
        resources:
          requests:
            memory: "3Gi"
            cpu: "2"
          limits:
            memory: "6Gi"
            cpu: "4"
        volumeMounts:
        - name: dev-kvm
          mountPath: /dev/kvm
        - name: user-data
          mountPath: /storage
      volumes:
      - name: dev-kvm
        hostPath:
          path: /dev/kvm
      - name: user-data
        emptyDir: {}
      restartPolicy: Always
    ---
    apiVersion: v1
    kind: Service
    metadata:
      name: vdi-{{ user }}-{{ project }}
      namespace: {{ namespace }}
      labels:
        app: vdi
        user: "{{ user }}"
        project: "{{ project }}"
        os-type: windows
    spec:
      selector:
        app: vdi
        user: "{{ user }}"
        project: "{{ project }}"
      ports:
      - name: rdp
        port: 3389
        targetPort: 3389
        protocol: TCP
      - name: vnc
        port: 5900
        targetPort: 5900
        protocol: TCP
      - name: web
        port: 8006
        targetPort: 8006
        protocol: TCP
      type: ClusterIP
